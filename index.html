<html>

  <head>
    <link rel="stylesheet" type="text/css" href="lib/main.css">
  </head>

  <body>


    <script src="lib/three.js"></script>
    <script src="lib/jquery.min.js"></script>
    <script src="lib/stats.min.js"></script>
    <script src="lib/underscore.js"></script>


    <script src="lib/TrackballControls.js"></script>
    <script src="lib/MouseMoveControls.js"></script>

    <script src="lib/OBJLoader.js" ></script>
    <script src="lib/ShaderLoader.js"></script>
    <script src="lib/Loader.js"></script>

    <script src="lib/GPGPU.js"></script>
    <script src="lib/CreatePositionsTexture.js"></script>


    <script src="lib/TextCreator.js"></script>
    <script src="lib/AudioController.js"></script>
    <script src="lib/AudioTexture.js"></script>
    <script src="lib/Stream.js"></script>

    <script src="lib/initRaycaster.js"></script>
    <script src="lib/initSongs.js"></script>
    <script src="lib/Flow.js"></script>
    <script src="lib/Song.js"></script>
    <script src="lib/Ball.js"></script>
    <script src="lib/Math.js"></script>


    <script id="vs-pass" type="x-shader/x-vertex" data-src="shaders/vs-pass.js">
    </script>
    <script id="fs-pass" type="x-shader/x-fragment" data-src="shaders/fs-pass.js">
    </script>
    <script id="vs-render" type="x-shader/x-vertex" data-src="shaders/vs-render.js">
    </script>
    <script id="fs-render" type="x-shader/x-fragment" data-src="shaders/fs-render.js">
    </script>
    <script id="vs-flow" type="x-shader/x-vertex" data-src="shaders/vs-flow.js">
    </script>
    <script id="fs-flow" type="x-shader/x-fragment" data-src="shaders/fs-flow.js">
    </script>

    <script id="vs-ball" type="x-shader/x-vertex" data-src="shaders/vs-ball.js">
    </script>
    <script id="fs-ball" type="x-shader/x-fragment" data-src="shaders/fs-ball.js">
    </script>

    <script id="vs-model" type="x-shader/x-vertex" data-src="shaders/vs-model.js">
    </script>
    <script id="fs-model" type="x-shader/x-fragment" data-src="shaders/fs-model.js">
    </script>

    <script id="vs-text" type="x-shader/x-vertex" data-src="shaders/vs-text.js">
    </script>
    <script id="fs-text" type="x-shader/x-fragment" data-src="shaders/fs-text.js">
    </script>



    <script>

      var camera, renderer, scene , controls ,stats;
      var size;


      var movementPlane;

      var vs, fs;

      var geometry, material , light;

      var rt_oPos, rt_pos, rt_out;
      var flowShader;
      var toGeo;
      var fromGeo;

      var loader;

      var vs = {};
      var fs = {};

      var loader = new Loader();

      var audioController = new AudioController();
      audioController.mute.gain.value = .0;

     
      var vertexShaders       = $('script[type="x-shader/x-vertex"]');
      var fragmentShaders     = $('script[type="x-shader/x-fragment"]');

      console.log( vertexShaders );
      console.log( fragmentShaders );
      
      loadShader( 'pass',   vertexShaders[0]    , 'vertex'    );
      loadShader( 'pass',   fragmentShaders[0]  , 'fragment'  );
      loadShader( 'render', vertexShaders[1]    , 'vertex'    );
      loadShader( 'render', fragmentShaders[1]  , 'fragment'  );
      loadShader( 'flow',   vertexShaders[2]    , 'vertex'    );
      loadShader( 'flow',   fragmentShaders[2]  , 'fragment'  );
      loadShader( 'ball',   vertexShaders[3]    , 'vertex'    );
      loadShader( 'ball',   fragmentShaders[3]  , 'fragment'  );
      loadShader( 'model',   vertexShaders[4]    , 'vertex'    );
      loadShader( 'model',   fragmentShaders[4]  , 'fragment'  );
      loadShader( 'text',   vertexShaders[5]    , 'vertex'    );
      loadShader( 'text',   fragmentShaders[5]  , 'fragment'  );


      loader.addToLoadBar();

      var sm = [

        ["download_1.png" , "System_Preferences.zip"],
        ["twitter_1.png" , "http://twitter.com/share?text=Check%20out%20interactive%20EP%20'System%20Preferences'%20by%20@rioux__;%20visualized%20by%20@cabbibo%20&url=http://cabbibo.com/rioux"],
        ["facebook_1.png" , 'http://www.facebook.com/sharer.php?u=http://cabbibo.com/rioux'],
        ["soundcloud_1.png" , "https://soundcloud.com/rioux"],
        ["cabbibo_1.png" , "http://wom.bs"],
        ["connect_1.png" , "http://co-nnect.me/"],
        ["rioux_1.png" , "http://rioux.fm/"],


      ]
      
      addSocial( sm );

      var mainMaterial =  new THREE.MeshBasicMaterial({
        color:0x000000,
        side:THREE.DoubleSide
      });

      loader.OBJLoader.load( 'lib/LeePerrySmith.obj' , function( object ){
        object.traverse( function ( child ) {
          if ( child instanceof THREE.Mesh ) {
            var geo = new THREE.Geometry();
            var mesh = new THREE.Mesh( child.geometry , mainMaterial );
            mesh.scale.multiplyScalar( 2000 );
            THREE.GeometryUtils.merge( geo , mesh );
            geo.computeVertexNormals();

            headGeo = geo;       
          }
        } );
        loader.loadBarAdd();
      });

      loader.OBJLoader.load( 'lib/logo.obj' , function( object ){
        object.traverse( function ( child ) {
            if ( child instanceof THREE.Mesh ) {
              var geo = new THREE.Geometry();
              var mesh = new THREE.Mesh( child.geometry , mainMaterial );
              mesh.scale.multiplyScalar( 30 );
              THREE.GeometryUtils.merge( geo , mesh );
              geo.computeVertexNormals();
              logoGeo = geo;       
            }
        });
        loader.loadBarAdd();
      });



      
      function init(){

        var w = window.innerWidth;
        var h = window.innerHeight;

        camera = new THREE.PerspectiveCamera( 65 , w/h , 1 , 30000 );
        camera.position.z = 6000;


        controls = new THREE.MouseMoveControls( camera );
        controls.z = 5000;
        //controls.speed=1;
        /*controls = new THREE.TrackballControls( camera );
        controls.rotateSpeed = 1;
        controls.minDistance = 1000;
        controls.maxDistance = 10000;
        controls.dynamicDampingFactor = .1;*/
        scene = new THREE.Scene();

        renderer = new THREE.WebGLRenderer();
        renderer.setSize( window.innerWidth, window.innerHeight );

        stats = new Stats();
        stats.domElement.id = "stats";
        document.body.appendChild( stats.domElement );

        size = 512;

        movementPlane = new THREE.Mesh( 
        new THREE.PlaneGeometry( 20000, 20000, 8, 8 ), 
        new THREE.MeshBasicMaterial({ 
          color: 0xffffff, 
         // opacity: 0.25,
         // transparent: true, 
          wireframe: true 
        } ) );
        movementPlane.visible = false;
        scene.add( movementPlane );

        flow = new Flow( size );

        initRaycaster();


        initSongs(); 


        flow.flowShader.uniforms.t_from.value = SONGS[0].fromTexture;
        flow.flowShader.uniforms.t_to.value = SONGS[0].toTexture;

        flow.particles.material.uniforms.map.value = SONGS[0].fromTexture;

        flow.sprite = THREE.ImageUtils.loadTexture( "lib/lensFlare.png" );
        flow.particles.material.uniforms.sprite.value = flow.sprite;
        //flow.fromTexure = .uniforms.map.value = flow.fromTexture;
        flow.fromTexure = SONGS[0].fromTexture;
        flow.toTexure = SONGS[0].toTexture;
        flow.reset( SONGS[0].fromTexture );

        //flow.addBalls();
        //flow.
        scene.add( flow.particles );


        document.body.appendChild( renderer.domElement );
        window.addEventListener( 'resize', onResize , false );
        

        SONGS[0].begin();
        loader.liftCurtain();
        animate();

      }

      
      function animate(){


        requestAnimationFrame( animate );
        stats.update();
         flow.update();
        audioController.update();
        
        controls.update();
         renderer.render( scene , camera );
      }

      function onResize() {
        windowHalfX = window.innerWidth / 2;
        windowHalfY = window.innerHeight / 2;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function loadShader( title , shader, type) {

          loader.addToLoadBar();
        
          // wrap up the shader for convenience
          var $shader = $(shader);
          
          // request the file over AJAX
          $.ajax({
              url: $shader.data('src'),
              dataType: 'text',
              context: {
                  name: $shader.data('name'),
                  type: type
              },
              complete: function(r){
                loader.loadBarAdd();
                if( type == 'vertex' ){
                  vs[title] = r.responseText;
                }else{
                  fs[title] = r.responseText;
                }

              }
          });
          
        }
    
      function addSocial( smArray ){

        this.social = document.createElement('div');
        this.social.id = 'social';
        document.body.appendChild( this.social );

        this.titleEP  = document.createElement('div');
        this.titleEP.id = 'titleEP';
        this.titleEP.innerHTML = 'Rioux - System Preferences';
        this.social.appendChild( this.titleEP  );

        for( var i  = 0; i < smArray.length; i ++ ){

          var a = document.createElement('a');
          a.href = smArray[i][1];
          a.target = '_blank';

          a.style.background = 'url( icons/'+smArray[i][0]+')';
          a.style.backgroundSize = '100%';
          a.className += 'social';

          this.social.appendChild( a );

        }

      }
    </script>

  </body>
</html>
