<html>

  <head>
    <link rel="stylesheet" type="text/css" href="lib/main.css">
  </head>

  <body>


    <script src="lib/three.js"></script>
    <script src="lib/jquery.min.js"></script>
    <script src="lib/underscore.js"></script>



    <script src="lib/TrackballControls.js"></script>
    <script src="lib/MouseMoveControls.js"></script>

    <script src="lib/OBJLoader.js" ></script>
    <script src="lib/ShaderLoader.js"></script>
    <script src="lib/Loader.js"></script>

    <script src="lib/GPGPU.js"></script>
    <script src="lib/CreatePositionsTexture.js"></script>


    <script src="lib/TextCreator.js"></script>
    <script src="lib/AudioController.js"></script>
    <script src="lib/AudioTexture.js"></script>
    <script src="lib/Stream.js"></script>

    <script src="lib/initRaycaster.js"></script>
    <script src="lib/Flow.js"></script>
    <script src="lib/Song.js"></script>


    <script id="vs-pass" type="x-shader/x-vertex" data-src="shaders/vs-pass.js">
    </script>
    <script id="fs-pass" type="x-shader/x-fragment" data-src="shaders/fs-pass.js">
    </script>
    <script id="vs-render" type="x-shader/x-vertex" data-src="shaders/vs-render.js">
    </script>
    <script id="fs-render" type="x-shader/x-fragment" data-src="shaders/fs-render.js">
    </script>
    <script id="vs-flow" type="x-shader/x-vertex" data-src="shaders/vs-flow.js">
    </script>
    <script id="fs-flow" type="x-shader/x-fragment" data-src="shaders/fs-flow.js">
    </script>

    <script id="vs-ball" type="x-shader/x-vertex" data-src="shaders/vs-ball.js">
    </script>
    <script id="fs-ball" type="x-shader/x-fragment" data-src="shaders/fs-ball.js">
    </script>

    <script id="vs-active" type="x-shader/x-vertex" data-src="shaders/vs-active.js">
    </script>
    <script id="fs-active" type="x-shader/x-fragment" data-src="shaders/fs-active.js">
    </script>


    <script>

      var camera, renderer, scene , controls;
      var size;
      
      var vs, fs;

      var geometry, material , light;

      var rt_oPos, rt_pos, rt_out;
      var flowShader;
      var toGeo;
      var fromGeo;

      var loader;

      var vs = {};
      var fs = {};

      var loader = new Loader();

      var audioController = new AudioController();
      audioController.mute.gain.value = .5;

     
      var vertexShaders       = $('script[type="x-shader/x-vertex"]');
      var fragmentShaders     = $('script[type="x-shader/x-fragment"]');

      console.log( vertexShaders );
      console.log( fragmentShaders );
      
      loadShader( 'pass',   vertexShaders[0]    , 'vertex'    );
      loadShader( 'pass',   fragmentShaders[0]  , 'fragment'  );
      loadShader( 'render', vertexShaders[1]    , 'vertex'    );
      loadShader( 'render', fragmentShaders[1]  , 'fragment'  );
      loadShader( 'flow',   vertexShaders[2]    , 'vertex'    );
      loadShader( 'flow',   fragmentShaders[2]  , 'fragment'  );
      loadShader( 'ball',   vertexShaders[3]    , 'vertex'    );
      loadShader( 'ball',   fragmentShaders[3]  , 'fragment'  );
      loadShader( 'active',   vertexShaders[4]    , 'vertex'    );
      loadShader( 'active',   fragmentShaders[4]  , 'fragment'  );

      loader.addToLoadBar();

      var mainMaterial =  new THREE.MeshBasicMaterial({
        color:0x000000
      });

      loader.OBJLoader.load( 'lib/LeePerrySmith.obj' , function( object ){
        object.traverse( function ( child ) {
          if ( child instanceof THREE.Mesh ) {
            var geo = new THREE.Geometry();
            var mesh = new THREE.Mesh( child.geometry , mainMaterial );
            mesh.scale.multiplyScalar( 500 );
            THREE.GeometryUtils.merge( geo , mesh );
            headGeo = geo;       
          }
        } );
        loader.loadBarAdd();
      });

      loader.OBJLoader.load( 'lib/logo.obj' , function( object ){
        object.traverse( function ( child ) {
            if ( child instanceof THREE.Mesh ) {
              var geo = new THREE.Geometry();
              var mesh = new THREE.Mesh( child.geometry , mainMaterial );
              mesh.scale.multiplyScalar( 3 );
              THREE.GeometryUtils.merge( geo , mesh );
              logoGeo = geo;       
            }
        });
        loader.loadBarAdd();
      });



      
      function init(){

        var w = window.innerWidth;
        var h = window.innerHeight;

        camera = new THREE.PerspectiveCamera( 65 , w/h , 1 , 10000 );
        camera.position.z = 4000;

        controls = new THREE.MouseMoveControls( camera );
        ///controls = new THREE.TrackballControls( camera );

        controls.z = 2000;
        controls = new THREE.TrackballControls( camera );
        scene = new THREE.Scene();

        renderer = new THREE.WebGLRenderer();
        renderer.setSize( window.innerWidth, window.innerHeight );


        size = 512;

        initRaycaster();

        flow = new Flow( size );

        /*fromPos = new THREE.Vector3( 1000 , 0 , 0  );
        toPos = new THREE.Vector3( -1000 , 0 , 0  );
        
        fromRot = new THREE.Euler( 0,-Math.PI / 2,0);
        toRot = new THREE.Euler( 0,Math.PI / 2,0);

        flow.fromTexture = flow.createPositionsTexture( fromGeo , fromPos , fromRot );
  
        flow.toTexture = flow.createPositionsTexture( toGeo , toPos , toRot );       
        flow.flowShader.uniforms.t_from.value = flow.fromTexture;
        //flow.flowShader.uniforms.t_to.value = flow.toTexture;*/


        /*

          Setting Up Songs

        */

        var geo = new THREE.IcosahedronGeometry( 100 , 3 );
        var geo = logoGeo;
        var geo = headGeo;
        geo.computeFaceNormals();
        geo.computeVertexNormals();
        //geo.computeF

        var to = new THREE.Mesh( geo , mainMaterial );
        to.position.set( -1000 , -500 , 0 );
        var from = new THREE.Mesh( geo , mainMaterial );
        from.position.set( 1000 , -500 , 0 );

        var title = 'Lucifer'
        var file  = 'audio/lucifer.mp3'
        new Song( flow , title , file , from , to  ,
        {
          curlSize:{type:"f"  , value:.01},
          dirPower:{type:"f"  , value:10.0},
          velPower:{type:"f"  , value:.3},
          curlPower:{type:"f"  , value:1.2},
          audioPower:{type:"f"  , value:.5},
          resetRadius:{type:"f"  , value:1.0}, 
        },

        {

          particleSize:{ type:"f" , value:900 },
          noiseSize:{ type:"f" , value:.001 },
          noisePower:{ type:"f" , value:5.5 },
          audioSizePower:{ type:"f" , value:4.1 },
          positionPower:{ type:"f" , value:5.4 },
          spritePower:{ type:"f" , value:.1 },
          audioPower:{ type:"v3" , value:new THREE.Vector3( 4.5 , 4 , 0 ) },
          colorPower:{ type:"f" , value:.6 },
          weirdPower:{ type:"f" , value:1 },
          finalDivision:{ type:"f" , value:2 },
          color:{ type:"v3" , value: new THREE.Vector3( 2.5 , .9 , 4. ) },

        });

      

        var to = new THREE.Mesh( geo , mainMaterial );
        to.position.set( -1000 , 500 , 0 );
        var from = new THREE.Mesh( geo , mainMaterial );
        from.position.set( 1000 , 500 , 0 );

        var title = 'Maze1'
        var file  = 'audio/maze1.mp3'
        new Song( flow , title , file , from , to  , {
          curlSize:{type:"f"  , value:.001},
          dirPower:{type:"f"  , value:1.0},
          velPower:{type:"f"  , value:.9},
          curlPower:{type:"f"  , value:.4},
          audioPower:{type:"f"  , value:.5},
          resetRadius:{type:"f"  , value:50.0}, 
        } ,
        
       {

          particleSize:{ type:"f" , value:10000 },
          noiseSize:{ type:"f" , value:.01 },
          noisePower:{ type:"f" , value:.1 },
          audioSizePower:{ type:"f" , value:1.3 },
          positionPower:{ type:"f" , value:.4 },
          spritePower:{ type:"f" , value:.1 },
          audioPower:{ type:"v3" , value:new THREE.Vector3( 1.5 , 4 , 10 ) },
          colorPower:{ type:"f" , value:1.6 },
          weirdPower:{ type:"f" , value:100 },
          finalDivision:{ type:"f" , value:1 },
          color:{ type:"v3" , value: new THREE.Vector3( 4.5 , .9 , 2. ) },

        } 
        );

        var to = new THREE.Mesh( geo , mainMaterial );
        to.position.set( -1000 , 200 , 0 );
        var from = new THREE.Mesh( geo , mainMaterial );
        from.position.set( 1000 , 200 , 0 );

        var title = 'Trails'
        var file  = 'audio/trails.mp3'
        new Song( flow , title , file , from , to  , {
          curlSize:{type:"f"  , value:.004},
          dirPower:{type:"f"  , value:2.0},
          velPower:{type:"f"  , value:.9},
          curlPower:{type:"f"  , value:1.2},
          audioPower:{type:"f"  , value:.5},
          resetRadius:{type:"f"  , value:10.0},
        },

        {

          particleSize:{ type:"f" , value:30000 },
          noiseSize:{ type:"f" , value:.01 },
          noisePower:{ type:"f" , value:.1 },
          audioSizePower:{ type:"f" , value:.2 },
          positionPower:{ type:"f" , value:10. },
          spritePower:{ type:"f" , value:.1 },
          audioPower:{ type:"v3" , value:new THREE.Vector3( .4 , 4 , 4 ) },
          colorPower:{ type:"f" , value:1.6 },
          weirdPower:{ type:"f" , value:10 },
          finalDivision:{ type:"f" , value:1 },
          color:{ type:"v3" , value: new THREE.Vector3( 1.5 , 2.9 , 2. ) },

        } 
        
        );

         var to = new THREE.Mesh( geo , mainMaterial );
        to.position.set( -1000 , -200 , 0 );
        var from = new THREE.Mesh( geo , mainMaterial );
        from.position.set( 1000 , -200 , 0 );

        var title = 'Tree Torrent'
        var file  = 'audio/treeTorrent.mp3'
        new Song( flow , title , file , from , to  ,{
          curlSize:{type:"f"  , value:.001},
          dirPower:{type:"f"  , value:4.0},
          velPower:{type:"f"  , value:.7},
          curlPower:{type:"f"  , value:2.2},
          audioPower:{type:"f"  , value:1.5},
          resetRadius:{type:"f"  , value:10.0},
        },
        {

          particleSize:{ type:"f" , value:10000 },
          noiseSize:{ type:"f" , value:.018 },
          noisePower:{ type:"f" , value:.00 },
          audioSizePower:{ type:"f" , value:.8 },
          positionPower:{ type:"f" , value:3. },
          spritePower:{ type:"f" , value:.1 },
          audioPower:{ type:"v3" , value:new THREE.Vector3( 1.5 , 10 , 1 ) },
          colorPower:{ type:"f" , value:1.6 },
          weirdPower:{ type:"f" , value:0 },
          finalDivision:{ type:"f" , value:1 },

          color:{ type:"v3" , value: new THREE.Vector3( 4.5 , .9 , 2. ) },

        } 
        
        );



        flow.flowShader.uniforms.t_from.value = SONGS[0].fromTexture;
        flow.flowShader.uniforms.t_to.value = SONGS[0].toTexture;

        flow.particles.material.uniforms.map.value = SONGS[0].fromTexture;

        flow.sprite = THREE.ImageUtils.loadTexture( "lib/lensFlare.png" );
        flow.particles.material.uniforms.sprite.value = flow.sprite;
        //flow.fromTexure = .uniforms.map.value = flow.fromTexture;
        flow.fromTexure = SONGS[0].fromTexture;
        flow.toTexure = SONGS[0].toTexture;
        flow.reset( SONGS[0].fromTexture );

        flow.addBalls();
        //flow.
        scene.add( flow.particles );


        document.body.appendChild( renderer.domElement );
        window.addEventListener( 'resize', onResize , false );
        

        animate();

      }

      
      function animate(){

        requestAnimationFrame( animate );
        controls.update();
        flow.update();
        audioController.update();
        renderer.render( scene , camera );
      }

      function onResize() {
        windowHalfX = window.innerWidth / 2;
        windowHalfY = window.innerHeight / 2;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function loadShader( title , shader, type) {

          loader.addToLoadBar();
        
          // wrap up the shader for convenience
          var $shader = $(shader);
          
          // request the file over AJAX
          $.ajax({
              url: $shader.data('src'),
              dataType: 'text',
              context: {
                  name: $shader.data('name'),
                  type: type
              },
              complete: function(r){
                console.log( 'hellos' );
                loader.loadBarAdd();
                if( type == 'vertex' ){
                  vs[title] = r.responseText;
                }else{
                  fs[title] = r.responseText;
                }

              }
          });
          
      }
    </script>

  </body>
</html>
